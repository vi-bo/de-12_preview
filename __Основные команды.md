| Основные команды                                                                                                 | Описание                                                                            |
| ---------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- |
| `sudo mv /tmp/kafka_2.13-3.2.3 /opt`                                                                             | переложить kafka в `/opt`                                                           |
| `sudo apt-get install zookeeperd`                                                                                | поставить zookeeper                                                                 |
| `touch /etc/systemd/system/zookeeper.service`                                                                    | создать сервис zookeeper                                                            |
| `touch /etc/systemd/system/kafka.service`                                                                        | создать сервис kafka                                                                |
| `vim /etc/systemd/system/kafka.service`                                                                          | поправить сервис kafka                                                              |
| `sudo cp /opt/kafka_2.13-3.2.3/config/server.properties /opt/kafka_2.13-<br/>3.2.3/config/server.properties_bak` | бэкап `server.properties`                                                           |
| `vim /opt/kafka_2.13-3.2.3/config/server.properties`                                                             | поправить настройки kafka (`advertised.listeners` и `listeners`)                    |
| `sudo systemctl restart kafka`                                                                                   | перезапустить сервис kafka                                                          |
| `sudo systemctl enable zookeeper`, `sudo systemctl start zookeeper`, `sudo systemctl status zookeeper`           | проверка автозапуск сервиса zookeeper                                               |
| `sudo systemctl enable kafka`, `sudo systemctl start kafka`, `sudo systemctl status kafka`                       | проверка автозапуск сервиса kafka                                                   |
| `/opt/kafka_2.13-3.2.3/bin/kafka-topics.sh --create --topic vibo.test.topic --bootstrap-server localhost:9092`   | создаем топик (из ноды1), используя консольную утилиту `kafka-topics.sh`            |
| `docker run -it --network=host edenhill/kcat:1.7.1 -b 94.139.246.228:9092 -L`                                    | посмотреть топик и метаданные (с другой машины) через `docker` `kcat` от `edenhill` |
| `docker run -it --network=host edenhill/kcat:1.7.1 -b 94.139.246.228:9092 -C -t vibo.test.topic`                 | консьюмить топик (с другой машины) через `docker` `kcat` от `edenhill`              |
| `docker run -it --network=host edenhill/kcat:1.7.1 -b 94.139.246.228:9092 -P -t vibo.test.topic`                 | продьюсить в топик (с другой машины) через `docker` `kcat` от `edenhill`            |
| ```vim /etc/hosts```                                                                                             | править`hosts`                                                                      |
| `sudo ufw status`                                                                                                | статус Firewall                                                                     |
| `sudo ufw allow 22/tcp`                                                                                          | добавить порт 22 (для соединения по ssh)                                            |
| `sudo ufw allow 9092/tcp`                                                                                        | добавить порт 9092 (для kafka)                                                      |
| `sudo ufw reload`                                                                                                | перезапустить Firewall                                                              |
| `scp ubuntu@de12-cn-1:/opt/kafka_2.13-3.2.3/config/server.properties_bak /home/vibo/Downloads/`                  | скопировать файл с удаленной машины                                                 |

| Основные команды                                                                                                                                      | Описание                                                                                         |
| ----------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| `sudo chmod 755 /etc/clickhouse-server/config.xml`                                                                                                    | расширение прав, чтобы небыло проблем при запуске                                                |
| `sudo ufw status`                                                                                                                                     | статус Firewall                                                                                  |
| `sudo ufw allow 9090/tcp`, `sudo ufw allow 9181/tcp`, `sudo ufw allow 9444/tcp`                                                                       | добавить порт 9090 (нативный клиент Clickhouse), 9181 (keeper_server), 9444 (raft_configuration) |
| `sudo ufw reload`                                                                                                                                     | перезапустить Firewall                                                                           |
| `sudo service clickhouse-server start`                                                                                                                | запуск сервиса `clickhouse-server`                                                               |
| `sudo service clickhouse-server stop`                                                                                                                 | остановка сервиса `clickhouse-server`                                                            |
| `clickhouse-client --port 9090 --query="show databases"`                                                                                              | проверка, выводит список дефолнтых баз                                                           |
| `clickhouse-client --port 9090`                                                                                                                       | проверка кластерного режима                                                                      |
| `CREATE DATABASE db_replicated ON CLUSTER 'cluster1';`                                                                                                | создание базы в кластере                                                                         |
| `cat <<END \| clickhouse-client --port 9090 --multiline`                                                                                              | создание таблицы                                                                                 |
| `clickhouse-client --port 9090 --query="show tables"`                                                                                                 | просмотр списка созданных таблиц                                                                 |
| `clickhouse-client --port 9090 --query="show create table example"`                                                                                   | просмотр таблицы `example`                                                                       |
| `cat /tmp/lab04_train_exploded50.json \| clickhouse-client --port 9090 --multiline --query="INSERT into my_table_gender_age_dist format JSONEachRow"` | заполнение таблицы `my_table_gender_age_dist` из файла `exploded50.json`                         |
| `clickhouse-client --port 9090 --query="select count(uid) from my_table_gender_age_dist"`                                                             | проверить количество строк в таблице `my_table_gender_age_dist`                                  |
| `curl -X GET http://localhost:8123/`                                                                                                                  | проверка REST API                                                                                |
| `curl -v -X GET http://localhost:8123/`                                                                                                               | проверка REST API (с получением кодов ответа)                                                    |
| `curl -X GET http://94.139.246.228:8123/`                                                                                                             | проверка REST API из вне                                                                         |
| `sudo ufw allow 8123/tcp`                                                                                                                             | добавить порт 8123 (REST API Clickhouse)                                                         |
| `virtualenv -p /usr/bin/python3 afenv`                                                                                                                | создание виртуальной среды `afenv`                                                               |
| `source /home/ubuntu/airflow/afenv/bin/activate`                                                                                                      | активация виртуальной среды `afenv`                                                              |
| `export AIRFLOW_HOME="pwd"/airflow_home`                                                                                                              | установка переменной среды `AIRFLOW_HOME`                                                        |
| `airflow db init`                                                                                                                                     | инициализация базы данных                                                                        |
| `airflow version`                                                                                                                                     | проверка версии `airflow`                                                                        |
| `airflow webserver -p 8081`                                                                                                                           | запуск приложения из виртуальной среды                                                           |
| `airflow scheduler`                                                                                                                                   | запуск шедуллера из виртуальной среды                                                            |
| `echo "export AIRFLOW_HOME=/home/ubuntu/airflow/airflow_home" >> ~/.bash_profile`                                                                     | установка значения переменной `AIRFLOW_HOME` в файл `~/.bash_profile`                            |
| `airflow config get-value webserver web_server_port`                                                                                                  | проверяем  на каком порту запущен airflow (из виртуальной среды)                                 |
| `airflow users create -r Admin -u admin -f V**** -l B**** -e vi.bo7@ya.ru -p '****'`                                                                  | создание пользователя-админа                                                                     |
| `airflow webserver`, `airflow scheduler`                                                                                                              | запуск airflow из виртуальной среды                                                              |
| `sudo systemctl enable airflow-webserver`                                                                                                             | активация сервиса `airflow-webserver`                                                            |
| `sudo systemctl status airflow-webserver`, `sudo systemctl start airflow-webserver`, `sudo systemctl stop airflow-webserver`                          | проверка статуса, стоп, старт сервиса `airflow-webserver`                                        |
| `sudo systemctl enable airflow-scheduler`                                                                                                             | активация сервиса `airflow-scheduler`                                                            |
| `sudo systemctl status airflow-scheduler`, `sudo systemctl start airflow-scheduler`, `sudo systemctl stop airflow-scheduler`                          | проверка статуса, стоп, старт сервиса `airflow-scheduler`                                        |
| `/opt/kafka_2.13-3.2.3/bin/kafka-topics.sh --create --topic ****_****_lab02_in --bootstrap-server localhost:9092`                                     | создать топик в kafka                                                                            |

| Основные команды                                                                        | Описание                                                               |
| --------------------------------------------------------------------------------------- | ---------------------------------------------------------------------- |
| `sudo apt update && sudo apt -y full-upgrade`                                           | обновление системных пакетов перед установкой spark на vk cloud клатер |
| `java -version`                                                                         | проверка версии java                                                   |
| `wget https://dlcdn.apache.org/spark/spark-3.2.3/spark-3.2.3-bin-hadoop3.2.tgz`         | скачиваем spark                                                        |
| `tar xvf spark-3.2.3-bin-hadoop3.2.tgz`                                                 | распаковываем архив                                                    |
| `sudo mv spark-3.2.3-bin-hadoop3.2 /opt/spark`                                          | переносим в opt                                                        |
| `sudo cp ~/.bashrc ~/.bashrc_bak`                                                       | бэкап переменных окружения                                             |
| `vim ~/.bashrc`                                                                         | правим перемпенную окружения                                           |
| `source ~/.bashrc`                                                                      | применение изменений                                                   |
| `pyspark`                                                                               | запуск спарк                                                           |
| `exit()`                                                                                | выход из спарк                                                         |
| `chmod 755 ~/labs/lab03/pyspark_test/submit-job-streaming-test.sh`                      | расширение права на использование скрипта                              |
| `./submit-job-streaming-test.sh`                                                        | запуск скрипта                                                         |
| `chmod +x ./submit-job.sh`                                                              | делаем скрипт выполняемым                                              |
| `hdfs dfs -rm -rf -f /tmp/checkpoint-read`, `hdfs dfs -rm -rf -f /tmp/checkpoint-write` | очистка папок при работе с hadoop-кластером                            |

| Основные команды                                                                                                                                                                                                                       | Описание                                       |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------- |
| `hdfs dfs -ls /user/vitaliy.bocharov`                                                                                                                                                                                                  | просмотр дирректории hadoop-кластера в hdfs    |
| `hive`                                                                                                                                                                                                                                 | запуск hive                                    |
| `create database vitaliy_bocharov location '/user/vitaliy.bocharov/warehouse';`                                                                                                                                                        | инициализация базы данных                      |
| `use vitaliy_bocharov;`                                                                                                                                                                                                                | вход в базу данных                             |
| `show tables;`                                                                                                                                                                                                                         | посмотреть перечень таблиц                     |
| `drop table vitaliy_bocharov.stg_car_sales;`                                                                                                                                                                                           | удаление таблицы                               |
| `show create table stg_car_sales;`                                                                                                                                                                                                     | просмотр параметров таблицы                    |
| `sqoop import --help;`                                                                                                                                                                                                                 | команды sqoop                                  |
| `sqoop import --connect jdbc:postgresql://10.0.1.25:5432/newprolab --driver org.postgresql.Driver --password **** --username **** --table car_sales -m 1 --target-dir /user/vitaliy.bocharov/warehouse/stg_car_sales --as-parquetfile` | загрузка данных из postgres в hdfs через sqoop |
| `select count(*) from stg_car_sales;`                                                                                                                                                                                                  | проверка загрузки всех данных (10000000)       |
| `select * from stg_car_sales limit 10;`                                                                                                                                                                                                | просмотр записей                               |

| Основные команды                                                                                                                                      | Описание                                                                  |
| ----------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| `sudo apt install python3.10-venv`                                                                                                                    | устанавливаем venv                                                        |
| `python3 -m venv flaskenv`                                                                                                                            | делаем виртуальное окружение для flask                                    |
| `source flaskenv/bin/activate`                                                                                                                        | активация виртуального окружения                                          |
| `pip install Flask==2.1.2`                                                                                                                            | ставим flask                                                              |
| `curl -XGET localhost:5000/health`                                                                                                                    | тестовая ручка health                                                     |
| `clickhouse-client --port 9090 --query="show databases"`                                                                                              | просмотр перечня баз данных                                               |
| `clickhouse-client --port 9090 --query="show tables"`                                                                                                 | просмотр перечня таблиц                                                   |
| `clickhouse-client --port 9090 --query="select * from example_view"`                                                                                  | просмотр таблицы example_view                                             |
| `scp lab04_train_exploded50.json de12-cn-1:/tmp`                                                                                                      | копирование данных с локалки на кластер                                   |
| `cat /tmp/lab04_train_exploded50.json \| clickhouse-client --port 9090 --multiline --query="INSERT into example_table format JSONEachRow"`            | добавляем данные lab04_train_exploded50.json в example_table              |
| `sudo docker build --tag my-lab04-flask-tutorial-app .`                                                                                               | создаем/обновляем образ                                                   |
| `docker build --tag my-lab04-flask-tutorial-app:1.0.0 --tag lab04-test build --tag .`                                                                 | если хотим указать версию в явном виде                                    |
| `sudo docker images`                                                                                                                                  | посмотреть образы                                                         |
| `sudo docker run --rm -p 7000:5000 my-lab04-flask-tutorial-app:latest`                                                                                | запуск контейнера на порту 7000, внутри приложение работает на порту 5000 |
| `curl -XGET 'http://localhost:7000/params?param1="hello"&param2=20'`                                                                                  | ручка params                                                              |
| `docker run -d --rm -p 7000:5000 my-lab04-flask-tutorial-app:1.0.0`                                                                                   | запуск с флагом -d?, работа в фоновом режиме                              |
| `docker ps`                                                                                                                                           | все запущенные контейнеры                                                 |
| `docker ps -a`                                                                                                                                        | история запуска контейнеров                                               |
| `/opt/kafka_2.13-3.2.3/bin/kafka-topics.sh --create --topic vitaliy_bocharov_lab04_in --bootstrap-server localhost:9092 --config retention.ms=300000` | создание топика кафка                                                     |
| `docker run -it --network=host edenhill/kcat:1.7.1 -b 94.139.246.228:9092 -C -t vitaliy_bocharov_lab04_in`                                            | слушаем топик кафки                                                       |

| Основные команды                                                                                                | Описание                                                                                                                           |
| --------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| `sudo docker run --rm -p 7000:5000 my-lab04-flask-tutorial-app:latest`                                          | запускаем контейнер с приложением                                                                                                  |
| `curl -XGET http://94.139.246.228:7000/health`                                                                  | проверка работоспособности приложения (5000 порт без докера)                                                                       |
| `pip install prometheus-flask-exporter`                                                                         | плагин для сбора данных из приложения (установить в виртуальное окружение)                                                         |
| `DEBUG_METRICS=1 python flask_lab04_tutorial_app.py`                                                            | запуск приложения без контейнера, с переменной окружения (разрешает сбор метрик)                                                   |
| `sudo prometheus --web.listen-address=:9000 &`                                                                  | запуск локально установленного prometheus по заданному порту                                                                       |
| `sudo docker run -p 9000:9090 -v /etc/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus` | запуск prometheus из контейнера с прописанными путями файла конфигурации prometheus.yml и портом 9000 (9090 конфликт с ClickHouse) |
| `sudo vim /etc/prometheus/prometheus.yml`                                                                       | правим файл конфигурации prometheus                                                                                                |
| `flask_http_request_duration_seconds_count{path="/health"}`                                                     | дергаем ручку в приложения для проверки графика в prometheus                                                                       |
